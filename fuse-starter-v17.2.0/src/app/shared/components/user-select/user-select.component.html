<div class="user-select-container">
    <!-- Label -->
    <label *ngIf="label" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
        {{label}}
        <span *ngIf="required" class="text-red-500">*</span>
    </label>

    <!-- Selected Users Display -->
    <div *ngIf="selectedUsers.length > 0" class="mb-3">
        <div class="flex flex-wrap gap-2">
            <div 
                *ngFor="let user of selectedUsers" 
                class="flex items-center space-x-2 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-full text-sm">
                <img 
                    *ngIf="showAvatar && user.avatar" 
                    [src]="user.avatar" 
                    [alt]="user.name" 
                    class="w-5 h-5 rounded-full object-cover">
                <span class="font-medium">{{user.name}}</span>
                <span *ngIf="showEmail" class="text-blue-600 dark:text-blue-300">({{user.email}})</span>
                <span 
                    *ngIf="showUserType" 
                    [class]="getUserTypeColor(user.userType)"
                    class="px-2 py-0.5 rounded text-xs">
                    {{getUserTypeDisplay(user.userType)}}
                </span>
                <button 
                    type="button"
                    (click)="removeUser(user)"
                    [disabled]="disabled"
                    class="text-blue-600 hover:text-blue-800 dark:text-blue-300 dark:hover:text-blue-100 disabled:opacity-50">
                    <mat-icon class="text-sm">close</mat-icon>
                </button>
            </div>
            <button 
                *ngIf="selectedUsers.length > 0"
                type="button"
                (click)="clearSelection()"
                [disabled]="disabled"
                class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 disabled:opacity-50">
                <mat-icon class="text-sm">clear_all</mat-icon>
            </button>
        </div>
    </div>

    <!-- Search Input -->
    <div class="relative">
        <mat-form-field appearance="outline" class="w-full">
            <mat-label>{{placeholder}}</mat-label>
            <input 
                matInput 
                [formControl]="searchControl"
                [placeholder]="loading ? 'Đang tải...' : placeholder"
                [disabled]="disabled || loading"
                (focus)="onInputFocus()"
                (blur)="onInputBlur()"
                autocomplete="off">
            <mat-icon matSuffix *ngIf="loading">
                <mat-spinner diameter="20"></mat-spinner>
            </mat-icon>
            <mat-icon matSuffix *ngIf="!loading">search</mat-icon>
        </mat-form-field>

        <!-- Error Message -->
        <div *ngIf="error" class="text-red-500 text-sm mt-1">
            {{error}}
        </div>

        <!-- Dropdown Options -->
        <div 
            *ngIf="!loading && !disabled && isDropdownOpen"
            (click)="onDropdownClick($event)"
            class="absolute z-50 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg max-h-60 overflow-y-auto">
            
            <!-- No Results -->
            <div 
                *ngIf="getDisplayUsers().length === 0" 
                class="px-4 py-3 text-gray-500 dark:text-gray-400 text-sm">
                Không tìm thấy người dùng nào
            </div>

            <!-- User Options -->
            <div 
                *ngFor="let user of getDisplayUsers()"
                (click)="onUserSelect(user)"
                [class.bg-blue-50]="isUserSelected(user)"
                [class.dark:bg-blue-900]="isUserSelected(user)"
                class="flex items-center space-x-3 px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-b-0">
                
                <!-- Avatar -->
                <div class="flex-shrink-0">
                    <img 
                        *ngIf="showAvatar && user.avatar" 
                        [src]="user.avatar" 
                        [alt]="user.name" 
                        class="w-8 h-8 rounded-full object-cover">
                    <div 
                        *ngIf="showAvatar && !user.avatar" 
                        class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center">
                        <mat-icon class="text-gray-500 dark:text-gray-400 text-sm">person</mat-icon>
                    </div>
                </div>

                <!-- User Info -->
                <div class="flex-1 min-w-0">
                    <div class="flex items-center space-x-2">
                        <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
                            {{user.name}}
                        </p>
                        <span 
                            *ngIf="showUserType" 
                            [class]="getUserTypeColor(user.userType)"
                            class="px-2 py-0.5 rounded text-xs">
                            {{getUserTypeDisplay(user.userType)}}
                        </span>
                    </div>
                    <p *ngIf="showEmail" class="text-xs text-gray-500 dark:text-gray-400 truncate">
                        {{user.email}}
                    </p>
                </div>

                <!-- Selection Indicator -->
                <div class="flex-shrink-0">
                    <mat-icon 
                        *ngIf="isUserSelected(user)"
                        class="text-blue-600 dark:text-blue-400 text-sm">
                        check
                    </mat-icon>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Text -->
    <div *ngIf="multiple && selectedUsers.length > 0" class="text-xs text-gray-500 dark:text-gray-400 mt-1">
        Đã chọn {{selectedUsers.length}} người dùng
    </div>
</div>
