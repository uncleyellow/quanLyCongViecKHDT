<div class="flex flex-col flex-auto md:w-160 md:min-w-160 max-h-160 -m-6 overflow-y-auto">

    <!-- Header -->
    <div class="flex flex-0 items-center justify-between h-16 pr-3 sm:pr-5 pl-6 sm:pl-8 bg-primary text-on-primary">
        <div class="text-lg font-medium">Công việc</div>
        <button mat-icon-button (click)="matDialogRef.close()" [tabIndex]="-1">
            <mat-icon class="text-current" [svgIcon]="'heroicons_outline:x'"></mat-icon>
        </button>
    </div>

    <!-- Card form -->
    <form class="flex flex-col flex-0 items-start w-full p-6 sm:p-8 space-y-6 overflow-y-auto" [formGroup]="cardForm">

        <!-- Time Tracking Section - Moved to top -->
        <div class="w-full">
            <div class="font-medium mb-3">Theo dõi thời gian</div>
            
            <!-- Time Summary -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium">Tổng thời gian:</span>
                    <span class="text-lg font-bold text-blue-600">{{ formatTime(card.totalTimeSpent || 0) }}</span>
                </div>
                
                <div class="flex justify-between items-center mb-2" *ngIf="card.isTracking">
                    <span class="text-sm font-medium">Phiên hiện tại:</span>
                    <span class="text-lg font-bold text-green-600">{{ formatTime(currentSessionTime) }}</span>
                </div>
                
                <div class="flex justify-between items-center" *ngIf="card.trackingPauseTime > 0">
                    <span class="text-sm font-medium">Thời gian tạm dừng:</span>
                    <span class="text-lg font-bold text-orange-600">{{ formatTime(card.trackingPauseTime) }}</span>
                </div>
            </div>

            <!-- Time Tracking Controls -->
            <div class="flex gap-2 mb-4">
                <!-- Start/Resume button -->
                <button 
                    *ngIf="!card.isTracking"
                    mat-flat-button 
                    color="primary" 
                    (click)="startOrResumeTracking()"
                    class="flex items-center gap-2">
                    <mat-icon>play_arrow</mat-icon>
                    {{ card.trackingStartTime ? 'Tiếp tục' : 'Bắt đầu' }}
                </button>

                <!-- Pause/Stop button -->
                <button 
                    *ngIf="card.isTracking"
                    mat-flat-button 
                    color="accent" 
                    (click)="pauseOrStopTracking()"
                    class="flex items-center gap-2">
                    <mat-icon>pause</mat-icon>
                    Tạm dừng/Kết thúc
                </button>

                <!-- Reset button -->
                <button 
                    mat-stroked-button 
                    color="warn" 
                    (click)="resetTotalTime()"
                    class="flex items-center gap-2">
                    <mat-icon>restart_alt</mat-icon>
                    Reset
                </button>
            </div>

            <!-- Tracking History Toggle -->
            <div *ngIf="trackingHistory.length > 0" class="mb-4">
                <button 
                    mat-stroked-button 
                    (click)="toggleHistory()"
                    class="w-full flex justify-between items-center">
                    <span>Lịch sử theo dõi ({{ trackingHistory.length }} bản ghi)</span>
                    <mat-icon>{{ showHistory ? 'expand_less' : 'expand_more' }}</mat-icon>
                </button>
                
                <!-- Latest Record Summary -->
                <div class="mt-2 p-3 bg-blue-50 rounded-lg">
                    <div class="text-sm font-medium text-blue-800">Bản ghi gần nhất:</div>
                    <div class="text-xs text-blue-600 mt-1">
                        {{ getActionText(trackingHistory[0]?.action) }} - {{ formatDateTime(trackingHistory[0]?.startTime) }}
                        <span *ngIf="trackingHistory[0]?.duration > 0" class="ml-2">
                            ({{ formatTime(trackingHistory[0]?.duration) }})
                        </span>
                    </div>
                </div>

                <!-- Full History (Collapsible) -->
                <div *ngIf="showHistory" class="mt-3 max-h-60 overflow-y-auto border rounded">
                    <div *ngFor="let record of trackingHistory" class="bg-white border-b p-3 last:border-b-0">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="text-sm font-medium">{{ getActionText(record.action) }}</span>
                                <span class="text-xs text-gray-500 ml-2">{{ formatDateTime(record.startTime) }}</span>
                            </div>
                            <span class="text-sm font-medium text-blue-600" *ngIf="record.duration > 0">
                                {{ formatTime(record.duration) }}
                            </span>
                        </div>
                        <div *ngIf="record.note" class="text-xs text-gray-600 mt-1">
                            {{ record.note }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Title -->
        <mat-form-field class="w-full" [subscriptSizing]="'dynamic'">
            <mat-label>Tiêu đề card</mat-label>
            <textarea matInput [formControlName]="'title'" [rows]="1" cdkTextareaAutosize [cdkAutosizeMinRows]="1">
            </textarea>
        </mat-form-field>

        <!-- Description -->
        <mat-form-field class="w-full" [subscriptSizing]="'dynamic'">
            <mat-label>Mô tả công việc</mat-label>
            <textarea matInput [formControlName]="'description'" [rows]="1" cdkTextareaAutosize
                [cdkAutosizeMinRows]="1">
            </textarea>
        </mat-form-field>

        <!-- Due date -->
        <div>
            <div class="font-medium">Ngày hết hạn</div>
            <div class="relative flex items-center mt-1.5 px-4 leading-9 rounded-full cursor-pointer"
                [ngClass]="{'text-gray-500 bg-gray-100 dark:text-gray-300 dark:bg-gray-700': !card.dueDate,
                            'text-green-800 bg-green-200 dark:text-green-100 dark:bg-green-500': card.dueDate && !isOverdue(card.dueDate),
                            'text-red-800 bg-red-200 dark:text-red-100 dark:bg-red-500': card.dueDate && isOverdue(card.dueDate)}" (click)="dueDatePicker.open()">
                <mat-icon class="icon-size-5 text-current" [svgIcon]="'heroicons_solid:calendar'"></mat-icon>
                <span class="ml-2 text-md font-medium">
                    <ng-container *ngIf="card.dueDate">{{card.dueDate | date:'longDate'}}</ng-container>
                    <ng-container *ngIf="!card.dueDate">Not set</ng-container>
                </span>
                <mat-form-field class="fuse-mat-dense invisible absolute inset-0 -mt-2.5 opacity-0 pointer-events-none"
                    [subscriptSizing]="'dynamic'">
                    <input matInput [formControlName]="'dueDate'" [matDatepicker]="dueDatePicker">
                    <mat-datepicker #dueDatePicker>
                        <mat-datepicker-actions>
                            <button mat-button (click)="cardForm.get('dueDate').setValue(null)" matDatepickerCancel>
                                Clear
                            </button>
                            <button mat-flat-button [color]="'primary'" matDatepickerApply>
                                Select
                            </button>
                        </mat-datepicker-actions>
                    </mat-datepicker>
                </mat-form-field>
            </div>
        </div>

        <!-- Labels -->
        <div class="w-full">
            <div class="font-medium">Nhãn Công Việc</div>
            <div class="mt-1 rounded-md border border-gray-300 shadow-sm overflow-hidden">
                <!-- Header -->
                <div class="flex items-center my-2 mx-3">
                    <div class="flex items-center flex-auto min-w-0">
                        <mat-icon class="icon-size-5 text-current mr-2" [svgIcon]="'heroicons_solid:tag'"></mat-icon>
                        <span class="text-sm font-medium">Labels</span>
                    </div>
                </div>
                <!-- Labels list -->
                <div class="px-3 pb-3">
                    <div class="flex flex-wrap gap-2">
                        <div *ngFor="let label of labels" class="flex items-center">
                            <mat-checkbox [checked]="hasLabel(label)" (change)="toggleProductTag(label, $event)"
                                class="mr-2">
                            </mat-checkbox>
                            <div class="w-3 h-3 rounded-full mr-2" [style.background-color]="label.color"></div>
                            <span class="text-sm">{{ label.title }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Checklist -->
        <div class="w-full">
            <div class="font-medium mb-3">Checklist</div>
            <div class="space-y-2 mb-3">
                <div *ngFor="let item of card.checklistItems; let i = index" class="flex items-center">
                    <mat-checkbox [checked]="item.checked" (change)="toggleChecklistItem(i)" class="mr-2">
                    </mat-checkbox>
                    <span class="flex-1" [class.line-through]="item.checked">{{item.text}}</span>
                    <button mat-icon-button color="warn" (click)="removeChecklistItem(i)" class="ml-2">
                        <mat-icon>delete</mat-icon>
                    </button>
                </div>
            </div>
            <div class="flex items-center">
                <input [(ngModel)]="newChecklistText" placeholder="Thêm mục..." class="flex-1 mr-2 mat-input-element"
                    [ngModelOptions]="{standalone: true}">
                <button mat-mini-fab color="primary" (click)="addChecklistItem()" type="button">
                    <mat-icon>add</mat-icon>
                </button>
            </div>
        </div>

        <!-- Label: nhập mới -->
        <mat-form-field class="w-full">
            <mat-label>Thêm nhãn mới (phân cách bằng dấu phẩy)</mat-label>
            <input matInput [(ngModel)]="newLabels" name="newLabels" [ngModelOptions]="{standalone: true}">
        </mat-form-field>

        <div class="font-medium">Thành viên phụ trách</div>
        <mat-select [(ngModel)]="selectedMember" name="selectedMember" [ngModelOptions]="{standalone: true}">

            <mat-option *ngIf="card.members.length === 0" value="">Không có</mat-option>
            <mat-option *ngFor="let member of card.members" [value]="member.id">
                <div class="flex items-center">
                    <ng-container *ngIf="member.avatar; else noAvatar">
                        <img [src]="member.avatar" alt="{{member.name}}"
                            class="w-6 h-6 rounded-full mr-2 object-cover" />
                    </ng-container>
                    <ng-template #noAvatar>
                        <span class="w-6 h-6 rounded-full mr-2 bg-gray-300 flex items-center justify-center text-xs">
                            {{ member.name.charAt(0).toUpperCase() }}
                        </span>
                    </ng-template>
                    {{ member.name }}
                </div>
            </mat-option>
        </mat-select>


    </form>
</div>

<!-- Member ngoài form -->
<div class="w-full flex justify-between items-end mt-4 bg-white">
    <div *ngFor="let member of card.members" [value]="member.id" class="relative group">
        <ng-container *ngIf="member.avatar; else noAvatarOverview">
            <img [src]="member.avatar" alt="{{member.name}}" class="w-6 h-6 rounded-full mr-2 object-cover cursor-pointer" />
        </ng-container>
        <ng-template #noAvatarOverview>
            <span class="w-6 h-6 rounded-full mr-2 bg-gray-300 flex items-center justify-center text-xs cursor-pointer">
                {{ member.name.charAt(0).toUpperCase() }}
            </span>
        </ng-template>
        <!-- Tooltip -->
        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10">
            {{ member.name }}
        </div>
    </div>


    <div class="flex gap-2 justify-end mt-4">
        <button mat-stroked-button type="button" (click)="onCancel()">Huỷ</button>
        <button mat-flat-button color="primary" type="button" (click)="onSave()">Lưu</button>
    </div>
</div>