<div class="flex flex-col flex-auto min-w-0">
    <!-- Department Sidebar for Boss Users -->
    <div *ngIf="showDepartmentSidebar" class="fixed left-0 top-34 h-[calc(100vh-193px)] w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 z-40 shadow-lg">
        <div class="flex flex-col h-full">
            <!-- Sidebar Header -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center space-x-2">
                    <mat-icon class="text-blue-500">business</mat-icon>
                    <h3 class="font-semibold text-gray-900 dark:text-white">Phòng ban</h3>
                </div>
                <button 
                    mat-icon-button 
                    (click)="clearDepartmentFilter()"
                    class="text-gray-500 hover:text-gray-700"
                    [disabled]="!selectedDepartmentId">
                    <mat-icon>clear_all</mat-icon>
                </button>
            </div>

            <!-- Loading State -->
            <div *ngIf="departmentSidebarLoading" class="flex items-center justify-center p-8">
                <mat-spinner diameter="32"></mat-spinner>
                <span class="ml-3 text-gray-500">Đang tải...</span>
            </div>

            <!-- Department List -->
            <div *ngIf="!departmentSidebarLoading" class="flex-1 overflow-y-auto">
                <!-- All Departments Option -->
                <div 
                    class="flex items-center space-x-3 p-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    [class.bg-blue-50]="!selectedDepartmentId"
                    [class.border-r-4]="!selectedDepartmentId"
                    [class.border-blue-500]="!selectedDepartmentId"
                    (click)="clearDepartmentFilter()">
                    <mat-icon class="text-gray-500">dashboard</mat-icon>
                    <div class="flex-1">
                        <p class="font-medium text-gray-900 dark:text-white">Tất cả phòng ban</p>
                        <p class="text-sm text-gray-500">Xem tổng quan toàn công ty</p>
                    </div>
                    <mat-icon *ngIf="!selectedDepartmentId" class="text-blue-500">check</mat-icon>
                </div>

                <!-- Individual Departments -->
                <div 
                    *ngFor="let department of departments" 
                    class="flex items-center space-x-3 p-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    [class.bg-blue-50]="selectedDepartmentId === department.id"
                    [class.border-r-4]="selectedDepartmentId === department.id"
                    [class.border-blue-500]="selectedDepartmentId === department.id"
                    (click)="selectDepartment(department.id)">
                    <mat-icon class="text-gray-500">business</mat-icon>
                    <div class="flex-1">
                        <p class="font-medium text-gray-900 dark:text-white">{{department.name}}</p>
                        <p *ngIf="department.description" class="text-sm text-gray-500">{{department.description}}</p>
                    </div>
                    <mat-icon *ngIf="selectedDepartmentId === department.id" class="text-blue-500">check</mat-icon>
                </div>

                <!-- Empty State -->
                <div *ngIf="departments.length === 0" class="flex flex-col items-center justify-center p-8 text-center">
                    <mat-icon class="text-gray-400 text-4xl mb-2">business</mat-icon>
                    <p class="text-gray-500">Không có phòng ban nào</p>
                </div>
            </div>

            <!-- Sidebar Footer -->
            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                <div class="text-xs text-gray-500 text-center">
                    <p>Đang xem: {{getSelectedDepartmentName()}}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content with Sidebar Offset -->
    <div [class.ml-64]="showDepartmentSidebar" class="flex flex-col flex-auto min-w-0 h-[calc(100vh-225px)]">

    <!-- Header with Add Widget Button and Filters -->
    <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between p-6 border-b bg-white dark:bg-gray-800 space-y-4 lg:space-y-0">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Dashboard Analytics</h1>
            <p class="text-gray-600 dark:text-gray-400">
                <span *ngIf="userRole === 'boss'">
                    <span *ngIf="selectedDepartmentId">Tổng quan phòng ban - {{getSelectedDepartmentName()}}</span>
                    <span *ngIf="!selectedDepartmentId">Tổng quan toàn công ty - Tất cả phòng ban</span>
                </span>
                <span *ngIf="userRole === 'manager'">Tổng quan phòng ban - {{userDepartment}}</span>
                <span *ngIf="userRole === 'staff'">Tổng quan cá nhân</span>
            </p>
            <div class="flex items-center space-x-2 mt-1">
                <span class="text-sm text-gray-500">Vai trò: </span>
                <span class="text-sm font-medium px-2 py-1 rounded-full" 
                      [ngClass]="{
                        'bg-red-100 text-red-800': userRole === 'boss',
                        'bg-blue-100 text-blue-800': userRole === 'manager',
                        'bg-green-100 text-green-800': userRole === 'staff'
                      }">
                    {{getRoleDisplayName(userRole)}}
                </span>
            </div>
        </div>
        
        <!-- Filter Controls -->
        <div class="flex flex-wrap items-center space-x-4">
            <!-- Due Date Filter -->
            <div class="flex flex-col space-y-2">
                <div class="text-sm font-medium text-gray-700 dark:text-gray-300">Ngày hết hạn</div>
                <div class="flex space-x-2">
                    <mat-form-field appearance="outline" class="w-42">
                        <mat-label>Từ ngày</mat-label>
                        <input matInput 
                               [matDatepicker]="dueDateStartPicker"
                               [(ngModel)]="dueDateRange.startDate" 
                               (ngModelChange)="onDueDateRangeChange()"
                               placeholder="Từ ngày"
                               [max]="dueDateRange.endDate">
                        <mat-datepicker-toggle matSuffix [for]="dueDateStartPicker"></mat-datepicker-toggle>
                        <mat-datepicker #dueDateStartPicker></mat-datepicker>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="w-42">
                        <mat-label>Đến ngày</mat-label>
                        <input matInput 
                               [matDatepicker]="dueDateEndPicker"
                               [(ngModel)]="dueDateRange.endDate" 
                               (ngModelChange)="onDueDateRangeChange()"
                               placeholder="Đến ngày"
                               [min]="dueDateRange.startDate">
                        <mat-datepicker-toggle matSuffix [for]="dueDateEndPicker"></mat-datepicker-toggle>
                        <mat-datepicker #dueDateEndPicker></mat-datepicker>
                    </mat-form-field>
                    <button mat-icon-button 
                            (click)="clearDueDateRange()"
                            [matTooltip]="'Xóa bộ lọc ngày'"
                            *ngIf="dueDateRange.startDate || dueDateRange.endDate"
                            class="text-red-500">
                        <mat-icon>clear</mat-icon>
                    </button>
                </div>
                <!-- Date range validation message -->
                <div class="text-xs text-red-500" 
                     *ngIf="dueDateRange.startDate && dueDateRange.endDate && isInvalidDueDateRange()">
                    Ngày bắt đầu phải trước hoặc bằng ngày kết thúc
                </div>
            </div>

            <!-- Advanced Filter Button -->
            <button
                mat-stroked-button
                (click)="openAdvancedFilters()"
                class="flex items-center space-x-2">
                <mat-icon>filter_list</mat-icon>
                <span>Bộ lọc nâng cao</span>
            </button>

            <!-- Add Widget Button -->
            <button
                mat-raised-button
                color="primary"
                (click)="openWidgetSelector()"
                class="flex items-center space-x-2">
                <mat-icon>add</mat-icon>
                <span>Thêm Widget</span>
            </button>
        </div>
    </div>

    <!-- Widget Grid Container -->
    <div class="flex-1 p-6 overflow-y-auto">
        <div 
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
            cdkDropList
            (cdkDropListDropped)="onDrop($event)">
            
            <!-- Gantt Chart Widget -->
            <div 
                class="widget-card bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700"
                cdkDrag
                [cdkDragData]="{ id: 'gantt', type: 'gantt' }"
                [style.grid-column]="widgetSizes.gantt.cols"
                [style.grid-row]="widgetSizes.gantt.rows">
                
                <!-- Widget Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center space-x-2">
                        <mat-icon class="text-blue-500">timeline</mat-icon>
                        <h3 class="font-semibold text-gray-900 dark:text-white">Biểu đồ Gantt</h3>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button mat-icon-button (click)="refreshWidget('gantt')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>refresh</mat-icon>
                        </button>
                        <button mat-icon-button (click)="configureWidget('gantt')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>settings</mat-icon>
                        </button>
                        <button mat-icon-button (click)="resizeWidget('gantt')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>open_in_full</mat-icon>
                        </button>
                        <button mat-icon-button (click)="removeWidget('gantt')" class="text-red-500 hover:text-red-700">
                            <mat-icon>close</mat-icon>
                        </button>
                    </div>
                </div>

                <!-- Gantt Controls -->
                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                    <div class="flex items-center space-x-4">
                        <mat-form-field appearance="outline" class="w-32">
                            <mat-label>Thời gian</mat-label>
                            <mat-select [(ngModel)]="selectedGanttTimeRange" (selectionChange)="selectGanttTimeRange($event.value)">
                                <mat-option *ngFor="let range of timeRangeOptions" [value]="range.value">
                                    {{range.label}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                    
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        Dữ liệu từ API
                    </div>
                </div>

                <!-- Widget Content -->
                <div class="p-4">
                    <div *ngIf="ganttLoading" class="flex items-center justify-center h-64">
                        <mat-spinner diameter="40"></mat-spinner>
                        <span class="ml-3 text-gray-500">Đang tải dữ liệu...</span>
                    </div>
                    
                    <div *ngIf="!ganttLoading" class="h-64">
                        <apx-chart
                            [series]="chartOptions.series"
                            [chart]="chartOptions.chart"
                            [plotOptions]="chartOptions.plotOptions"
                            [xaxis]="chartOptions.xaxis"
                            [yaxis]="chartOptions.yaxis"
                            [dataLabels]="chartOptions.dataLabels"
                            [tooltip]="chartOptions.tooltip"
                            [title]="chartOptions.title">
                        </apx-chart>
                    </div>
                </div>
            </div>

            <!-- Task Status Widget -->
            <div 
                class="widget-card bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700"
                cdkDrag
                [cdkDragData]="{ id: 'status', type: 'status' }"
                [style.grid-column]="widgetSizes.status.cols"
                [style.grid-row]="widgetSizes.status.rows">
                
                <!-- Widget Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center space-x-2">
                        <mat-icon class="text-green-500">pie_chart</mat-icon>
                        <h3 class="font-semibold text-gray-900 dark:text-white">Trạng thái công việc</h3>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button mat-icon-button (click)="refreshWidget('status')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>refresh</mat-icon>
                        </button>
                        <button mat-icon-button (click)="configureWidget('status')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>settings</mat-icon>
                        </button>
                        <button mat-icon-button (click)="resizeWidget('status')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>open_in_full</mat-icon>
                        </button>
                        <button mat-icon-button (click)="removeWidget('status')" class="text-red-500 hover:text-red-700">
                            <mat-icon>close</mat-icon>
                        </button>
                    </div>
                </div>

                <!-- Widget Content -->
                <div class="p-4">
                    <div class="h-64">
                        <apx-chart
                            [series]="statusChartOptions.series"
                            [chart]="statusChartOptions.chart"
                            [labels]="statusChartOptions.labels"
                            [colors]="statusChartOptions.colors"
                            [responsive]="statusChartOptions.responsive">
                        </apx-chart>
                    </div>
                </div>
            </div>

            <!-- Recent Activities Widget -->
            <div 
                class="widget-card bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700"
                cdkDrag
                [cdkDragData]="{ id: 'activities', type: 'activities' }"
                [style.grid-column]="widgetSizes.activities.cols"
                [style.grid-row]="widgetSizes.activities.rows">
                
                <!-- Widget Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center space-x-2">
                        <mat-icon class="text-purple-500">activity</mat-icon>
                        <h3 class="font-semibold text-gray-900 dark:text-white">Hoạt động gần đây</h3>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button mat-icon-button (click)="refreshWidget('activities')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>refresh</mat-icon>
                        </button>
                        <button mat-icon-button (click)="configureWidget('activities')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>settings</mat-icon>
                        </button>
                        <button mat-icon-button (click)="resizeWidget('activities')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>open_in_full</mat-icon>
                        </button>
                        <button mat-icon-button (click)="removeWidget('activities')" class="text-red-500 hover:text-red-700">
                            <mat-icon>close</mat-icon>
                        </button>
                    </div>
                </div>

                <!-- Widget Content -->
                <div class="p-4">
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        <div *ngFor="let activity of recentActivities" class="flex items-start space-x-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                                    <mat-icon class="text-blue-600 dark:text-blue-400 text-sm">update</mat-icon>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 dark:text-white">{{activity.title}}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{activity.time}}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Task Progress Widget -->
            <div 
                class="widget-card bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700"
                cdkDrag
                [cdkDragData]="{ id: 'progress', type: 'progress' }"
                [style.grid-column]="widgetSizes.progress.cols"
                [style.grid-row]="widgetSizes.progress.rows">
                
                <!-- Widget Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center space-x-2">
                        <mat-icon class="text-orange-500">trending_up</mat-icon>
                        <h3 class="font-semibold text-gray-900 dark:text-white">Tiến độ công việc</h3>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button mat-icon-button (click)="refreshWidget('progress')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>refresh</mat-icon>
                        </button>
                        <button mat-icon-button (click)="configureWidget('progress')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>settings</mat-icon>
                        </button>
                        <button mat-icon-button (click)="resizeWidget('progress')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>open_in_full</mat-icon>
                        </button>
                        <button mat-icon-button (click)="removeWidget('progress')" class="text-red-500 hover:text-red-700">
                            <mat-icon>close</mat-icon>
                        </button>
                    </div>
                </div>

                <!-- Widget Content -->
                <div class="p-4">
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Hoàn thành</span>
                            <span class="text-sm font-bold text-green-600">{{progressData.completed?.toFixed(2)}}%</span>
                        </div>
                        <mat-progress-bar 
                            mode="determinate" 
                            [value]="progressData.completed"
                            color="primary"
                            class="h-2">
                        </mat-progress-bar>
                        
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{progressData.total}}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Tổng công việc</div>
                            </div>
                            <div class="text-center p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <div class="text-2xl font-bold text-green-600 dark:text-green-400">{{progressData.completedCount}}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Đã hoàn thành</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Project Members Widget -->
            <div 
                class="widget-card bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700"
                cdkDrag
                [cdkDragData]="{ id: 'members', type: 'members' }"
                [style.grid-column]="widgetSizes.members.cols"
                [style.grid-row]="widgetSizes.members.rows">
                
                <!-- Widget Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center space-x-2">
                        <mat-icon class="text-indigo-500">people</mat-icon>
                        <h3 class="font-semibold text-gray-900 dark:text-white">Thành viên hoạt động</h3>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button mat-icon-button (click)="refreshWidget('members')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>refresh</mat-icon>
                        </button>
                        <button mat-icon-button (click)="configureWidget('members')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>settings</mat-icon>
                        </button>
                        <button mat-icon-button (click)="resizeWidget('members')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>open_in_full</mat-icon>
                        </button>
                        <button mat-icon-button (click)="removeWidget('members')" class="text-red-500 hover:text-red-700">
                            <mat-icon>close</mat-icon>
                        </button>
                    </div>
                </div>

                <!-- Widget Content -->
                <div class="p-4">
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        <div *ngFor="let member of projectMembers" class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div class="flex-shrink-0">
                                <img [src]="member.avatar" [alt]="member.name" class="w-10 h-10 rounded-full object-cover">
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 dark:text-white">{{member.name}}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{member.role}} • {{member.tasksCount}} công việc</p>
                                <div class="flex space-x-2 mt-1">
                                    <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded">{{member.tasksCount}} tổng</span>
                                    <span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded">{{member.doneTasks || 0}} hoàn thành</span>
                                    <span class="text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded">{{member.inProgressTasks || 0}} đang làm</span>
                                    <span class="text-xs px-2 py-1 bg-red-100 text-red-800 rounded">{{member.overdueTasks || 0}} quá hạn</span>
                                </div>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="w-3 h-3 rounded-full" 
                                     [ngClass]="{
                                         'bg-green-500': member.status === 'online',
                                         'bg-gray-400': member.status === 'offline',
                                         'bg-yellow-500': member.status === 'away'
                                     }">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart Type Widget -->
            <div 
                class="widget-card bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700"
                cdkDrag
                [cdkDragData]="{ id: 'chart', type: 'chart' }"
                [style.grid-column]="widgetSizes.chart.cols"
                [style.grid-row]="widgetSizes.chart.rows">
                
                <!-- Widget Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center space-x-2">
                        <mat-icon class="text-red-500">bar_chart</mat-icon>
                        <h3 class="font-semibold text-gray-900 dark:text-white">Biểu đồ dữ liệu thực</h3>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button mat-icon-button (click)="refreshWidget('chart')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>refresh</mat-icon>
                        </button>
                        <button mat-icon-button (click)="configureWidget('chart')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>settings</mat-icon>
                        </button>
                        <button mat-icon-button (click)="resizeWidget('chart')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>open_in_full</mat-icon>
                        </button>
                        <button mat-icon-button (click)="removeWidget('chart')" class="text-red-500 hover:text-red-700">
                            <mat-icon>close</mat-icon>
                        </button>
                    </div>
                </div>

                <!-- Chart Controls -->
                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                    <div class="flex items-center space-x-4">
                        <mat-form-field appearance="outline" class="w-48">
                            <mat-label>Loại biểu đồ</mat-label>
                            <mat-select [(ngModel)]="selectedChartType" (selectionChange)="selectChartType($event.value)">
                                <mat-option *ngFor="let type of chartTypes" [value]="type.value">
                                    {{type.label}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                        
                        <mat-form-field appearance="outline" class="w-32">
                            <mat-label>Thời gian</mat-label>
                            <mat-select [(ngModel)]="selectedTimeRange" (selectionChange)="selectTimeRange($event.value)">
                                <mat-option *ngFor="let range of timeRangeOptions" [value]="range.value">
                                    {{range.label}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                    
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        Dữ liệu từ API
                    </div>
                </div>

                <!-- Widget Content -->
                <div class="p-4">
                    <div class="h-64">
                        <div *ngIf="loading" class="flex items-center justify-center h-full">
                            <mat-spinner diameter="40"></mat-spinner>
                            <span class="ml-3 text-gray-500">Đang tải dữ liệu...</span>
                        </div>
                        
                        <apx-chart
                            *ngIf="!loading"
                            [series]="dynamicChartOptions.series"
                            [chart]="dynamicChartOptions.chart"
                            [xaxis]="dynamicChartOptions.xaxis"
                            [yaxis]="dynamicChartOptions.yaxis"
                            [plotOptions]="dynamicChartOptions.plotOptions"
                            [dataLabels]="dynamicChartOptions.dataLabels"
                            [colors]="dynamicChartOptions.colors"
                            [labels]="dynamicChartOptions.labels">
                        </apx-chart>
                    </div>
                </div>
            </div>

            <!-- Role Summary Widget -->
            <div 
                class="widget-card bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700"
                cdkDrag
                [cdkDragData]="{ id: 'role-summary', type: 'role-summary' }"
                [style.grid-column]="widgetSizes['role-summary'].cols"
                [style.grid-row]="widgetSizes['role-summary'].rows">
                
                <!-- Widget Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center space-x-2">
                        <mat-icon class="text-purple-500">admin_panel_settings</mat-icon>
                        <h3 class="font-semibold text-gray-900 dark:text-white">Tổng quan theo vai trò</h3>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button mat-icon-button (click)="refreshWidget('role-summary')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>refresh</mat-icon>
                        </button>
                        <button mat-icon-button (click)="configureWidget('role-summary')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>settings</mat-icon>
                        </button>
                        <button mat-icon-button (click)="resizeWidget('role-summary')" class="text-gray-500 hover:text-gray-700">
                            <mat-icon>open_in_full</mat-icon>
                        </button>
                        <button mat-icon-button (click)="removeWidget('role-summary')" class="text-red-500 hover:text-red-700">
                            <mat-icon>close</mat-icon>
                        </button>
                    </div>
                </div>

                <!-- Widget Content -->
                <div class="p-4">
                    <div class="space-y-4">
                        <!-- Role Information -->
                        <div class="bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-semibold text-gray-900 dark:text-white">{{getRoleDisplayName(userRole)}}</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        <span *ngIf="userRole === 'boss'">
                                            <span *ngIf="selectedDepartmentId">Quyền truy cập: Phòng {{getSelectedDepartmentName()}}</span>
                                            <span *ngIf="!selectedDepartmentId">Quyền truy cập: Toàn công ty</span>
                                        </span>
                                        <span *ngIf="userRole === 'manager'">Quyền truy cập: Phòng {{userDepartment}}</span>
                                        <span *ngIf="userRole === 'staff'">Quyền truy cập: Cá nhân</span>
                                    </p>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">
                                        {{progressData.total}}
                                    </div>
                                    <div class="text-xs text-gray-500">Tổng công việc</div>
                                </div>
                            </div>
                        </div>

                        <!-- Statistics Grid -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <div class="text-xl font-bold text-green-600 dark:text-green-400">{{progressData.completedCount}}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Hoàn thành</div>
                            </div>
                            <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <div class="text-xl font-bold text-blue-600 dark:text-blue-400">{{progressData.inProgress}}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Đang thực hiện</div>
                            </div>
                            <div class="text-center p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                                <div class="text-xl font-bold text-yellow-600 dark:text-yellow-400">{{progressData.pending}}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Chờ xử lý</div>
                            </div>
                            <div class="text-center p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">
                                <div class="text-xl font-bold text-red-600 dark:text-red-400">{{progressData.overdue}}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Quá hạn</div>
                            </div>
                        </div>

                        <!-- Completion Rate -->
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Tỷ lệ hoàn thành</span>
                                <span class="text-sm font-bold text-green-600">{{progressData.completed?.toFixed(1)}}%</span>
                            </div>
                            <mat-progress-bar 
                                mode="determinate" 
                                [value]="progressData.completed"
                                color="primary"
                                class="h-2">
                            </mat-progress-bar>
                        </div>

                        <!-- Role-specific insights -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                            <h5 class="font-medium text-gray-900 dark:text-white mb-2">Thông tin chi tiết</h5>
                            <div class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                                <div *ngIf="userRole === 'boss'">
                                    <p *ngIf="!selectedDepartmentId">• Xem thống kê từ tất cả phòng ban trong công ty</p>
                                    <p *ngIf="!selectedDepartmentId">• Theo dõi hiệu suất tổng thể của tổ chức</p>
                                    <p *ngIf="!selectedDepartmentId">• Phân tích xu hướng toàn công ty</p>
                                    <p *ngIf="selectedDepartmentId">• Xem thống kê chi tiết của phòng {{getSelectedDepartmentName()}}</p>
                                    <p *ngIf="selectedDepartmentId">• Theo dõi hiệu suất và tiến độ của phòng ban</p>
                                    <p *ngIf="selectedDepartmentId">• Phân tích dữ liệu cụ thể của phòng ban</p>
                                </div>
                                <div *ngIf="userRole === 'manager'">
                                    <p>• Quản lý công việc của phòng {{userDepartment}}</p>
                                    <p>• Theo dõi tiến độ nhóm</p>
                                    <p>• Phân bổ công việc hiệu quả</p>
                                </div>
                                <div *ngIf="userRole === 'staff'">
                                    <p>• Theo dõi công việc cá nhân</p>
                                    <p>• Quản lý thời gian hiệu quả</p>
                                    <p>• Cập nhật tiến độ công việc</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Widget Selector Dialog -->
    <div *ngIf="showWidgetSelector" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Thêm Widget</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div 
                        *ngFor="let widget of availableWidgets" 
                        class="flex flex-col p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer"
                        (click)="addWidget(widget)">
                        <div class="flex items-center mb-3">
                            <mat-icon class="text-gray-500 mr-3">{{widget.icon}}</mat-icon>
                            <h3 class="font-medium text-gray-900 dark:text-white">{{widget.title}}</h3>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">{{widget.description}}</p>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-400">Kích thước: {{widget.defaultSize}}</span>
                            <mat-icon class="text-gray-400">add</mat-icon>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button 
                        mat-button 
                        (click)="closeWidgetSelector()"
                        class="text-gray-600 dark:text-gray-400">
                        Hủy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Filters Dialog -->
    <div *ngIf="showAdvancedFilters" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Bộ lọc nâng cao</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Date Range -->
                    <mat-form-field appearance="outline">
                        <mat-label>Khoảng thời gian</mat-label>
                        <mat-select [(ngModel)]="dateRange">
                            <mat-option value="today">Hôm nay</mat-option>
                            <mat-option value="week">Tuần này</mat-option>
                            <mat-option value="month">Tháng này</mat-option>
                            <mat-option value="quarter">Quý này</mat-option>
                            <mat-option value="year">Năm nay</mat-option>
                            <mat-option value="custom">Tùy chỉnh</mat-option>
                        </mat-select>
                    </mat-form-field>

                    <!-- Priority -->
                    <mat-form-field appearance="outline">
                        <mat-label>Mức độ ưu tiên</mat-label>
                        <mat-select [(ngModel)]="selectedPriority">
                            <mat-option value="">Tất cả</mat-option>
                            <mat-option value="high">Cao</mat-option>
                            <mat-option value="medium">Trung bình</mat-option>
                            <mat-option value="low">Thấp</mat-option>
                        </mat-select>
                    </mat-form-field>

                    <!-- Completion Rate -->
                    <mat-form-field appearance="outline">
                        <mat-label>Tỷ lệ hoàn thành</mat-label>
                        <mat-select [(ngModel)]="completionRate">
                            <mat-option value="">Tất cả</mat-option>
                            <mat-option value="0-25">0-25%</mat-option>
                            <mat-option value="25-50">25-50%</mat-option>
                            <mat-option value="50-75">50-75%</mat-option>
                            <mat-option value="75-100">75-100%</mat-option>
                        </mat-select>
                    </mat-form-field>

                    <!-- Department -->
                    <mat-form-field appearance="outline">
                        <mat-label>Phòng ban</mat-label>
                        <mat-select [(ngModel)]="selectedDepartment">
                            <mat-option value="">Tất cả</mat-option>
                            <mat-option value="development">Phát triển</mat-option>
                            <mat-option value="testing">Kiểm thử</mat-option>
                            <mat-option value="design">Thiết kế</mat-option>
                            <mat-option value="marketing">Marketing</mat-option>
                        </mat-select>
                    </mat-form-field>

                    <!-- Tags -->
                    <mat-form-field appearance="outline">
                        <mat-label>Tags</mat-label>
                        <mat-select [(ngModel)]="selectedTags" multiple>
                            <mat-option value="urgent">Khẩn cấp</mat-option>
                            <mat-option value="bug">Bug</mat-option>
                            <mat-option value="feature">Tính năng mới</mat-option>
                            <mat-option value="improvement">Cải tiến</mat-option>
                        </mat-select>
                    </mat-form-field>

                    <!-- Workload -->
                    <mat-form-field appearance="outline">
                        <mat-label>Khối lượng công việc</mat-label>
                        <mat-select [(ngModel)]="workload">
                            <mat-option value="">Tất cả</mat-option>
                            <mat-option value="light">Nhẹ (1-3h)</mat-option>
                            <mat-option value="medium">Trung bình (4-8h)</mat-option>
                            <mat-option value="heavy">Nặng (8h+)</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button 
                        mat-button 
                        (click)="resetAdvancedFilters()"
                        class="text-gray-600 dark:text-gray-400">
                        Đặt lại
                    </button>
                    <button 
                        mat-raised-button
                        color="primary"
                        (click)="applyAdvancedFilters()">
                        Áp dụng
                    </button>
                    <button 
                        mat-button 
                        (click)="closeAdvancedFilters()"
                        class="text-gray-600 dark:text-gray-400">
                        Hủy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Widget Configuration Dialog -->
    <div *ngIf="showWidgetConfig" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Cấu hình Widget</h2>
                
                <div class="space-y-4">
                    <!-- Chart Type Selection -->
                    <div *ngIf="configuringWidget?.type === 'chart'">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Loại biểu đồ</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button 
                                *ngFor="let chartType of chartTypes"
                                (click)="selectChartType(chartType.value)"
                                [class]="selectedChartType === chartType.value ? 
                                    'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                                class="p-3 rounded-lg text-sm font-medium">
                                {{chartType.label}}
                            </button>
                        </div>
                    </div>

                    <!-- Widget Size -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Kích thước widget</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button 
                                *ngFor="let size of widgetSizeOptions"
                                (click)="selectWidgetSize(size.value)"
                                [class]="selectedWidgetSize === size.value ? 
                                    'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                                class="p-2 rounded text-xs">
                                {{size.label}}
                            </button>
                        </div>
                    </div>

                    <!-- Data Source -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Nguồn dữ liệu</mat-label>
                        <mat-select [(ngModel)]="selectedDataSource">
                            <mat-option value="all">Tất cả dự án</mat-option>
                            <mat-option value="current">Dự án hiện tại</mat-option>
                            <mat-option value="assigned">Công việc được giao</mat-option>
                            <mat-option value="created">Công việc đã tạo</mat-option>
                        </mat-select>
                    </mat-form-field>

                    <!-- Refresh Interval -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Tự động cập nhật</mat-label>
                        <mat-select [(ngModel)]="refreshInterval">
                            <mat-option value="0">Không tự động</mat-option>
                            <mat-option value="30">30 giây</mat-option>
                            <mat-option value="60">1 phút</mat-option>
                            <mat-option value="300">5 phút</mat-option>
                            <mat-option value="900">15 phút</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button 
                        mat-button 
                        (click)="closeWidgetConfig()"
                        class="text-gray-600 dark:text-gray-400">
                        Hủy
                    </button>
                    <button 
                        mat-raised-button
                        color="primary"
                        (click)="saveWidgetConfig()">
                        Lưu
                    </button>
                </div>
            </div>
        </div>
    </div>

    </div>
</div>
